# Linux安全：AppArmor


## 简介

AppArmor是一项安全功能，可以在许多Linux发行版中找到。如：

* Annvix
* Arch Linux
* SLES
* openSUSE
* CentOS
* Debian
* Gentoo
* Pardus Linux
* PLD
* Ubuntu

同SELinux，Apparmor也是内核增强功能，旨在将程序限制在有限的资源集中。由于 AppArmor 和 SELinux 使用了同样的框架，所以它们可以互换。AppArmor 的开发初衷是因为人们认为 SELinux 太过复杂，不适合普通用户管理。Apparmor与其他安全工具的不同之处在于，它将访问控制属性绑定到程序而不是单个用户。

与SELinux相比，优势在于其易用性，实现同样的功能限制，会比使用SELinux的规则代码少很多；而且从代码的可读性上来看，apparmor的代码也更易理解和易读。

从安全性上来说，毋庸置疑，SELinux更安全。从理论上也可以了解到SELinux与Apparmor最大的区别在于：Apparmor使用文件名（路径名）最为安全标签，而SELinux使用文件的inode作为安全标签，这就意味着，Apparmor机制可以通过修改文件名而被绕过，另外，在文件系统中，只有inode才具有唯一性。



## 使用

`apparmor-utils`软件包包含用于配置Apparmor的命令行工具。使用它可以更改Apparmor的执行模式，查找创建新配置文件的配置文件状态等。

`/etc/apparmor.d/`是Apparmor策略配置的主要目录。

#### 状态管理

Apparmor的限制是由加载到内核中的特殊配置文件提供的。这些配置文件可以在两种模式下运行：complain mode或enforce mode。

* Enforcement(强制): 以enforce模式加载的配置文件将导致配置文件中定义的策略被强制执行，同时对于违反这些限制条件的程序会进行日志记录（通过 syslog 或 auditd）。
* Complain(投诉): Complain模式下的配置文件不会强制执行策略，而是报告违反策略的尝试，不会对程序的行为进行限制，只是进行记录。

状态的查看

```bash
 # apparmor_status
apparmor module is loaded.
14 profiles are loaded.
14 profiles are in enforce mode.
   /usr/bin/man
   /usr/lib/NetworkManager/nm-dhcp-client.action
   /usr/lib/NetworkManager/nm-dhcp-helper
   /usr/lib/connman/scripts/dhclient-script
   /usr/sbin/named
   /usr/sbin/ntpd
   /usr/sbin/tcpdump
   /{,usr/}sbin/dhclient
   docker-default
   lsb_release
   man_filter
   man_groff
   nvidia_modprobe
   nvidia_modprobe//kmod
0 profiles are in complain mode.
4 processes have profiles defined.
4 processes are in enforce mode.
   /usr/sbin/named (732)
   /usr/sbin/ntpd (8750)
   /usr/local/bin/redis-server (57596) docker-default
   /usr/sbin/mysqld (501935) docker-default
0 processes are in complain mode.
0 processes are unconfined but have a profile defined.
```

#### 文件系统的访问控制

#### 常用命令

相关软件包 `apparmor-profiles`, `apparmor-utils`
* apparmor_status: 看AppArmor配置文件的当前状态的
* apparmor_parser: 这个就是将AppArmor配置文件直接加载到内核
* aa-complain: 这个可以把AppArmor配置文件设置为complain模式
* aa-enforce: 将AppArmor配置文件设置为enforce模式

| 权限符 | 说明 |
| - | - |
| r | 阅读 |
| w | 写 |
| ux | 无约束执行 |
| Ux | 无约束执行 – 擦洗环境 |
| px | 离散配置文件执行 |
| Px | 离散配置文件执行 – 清理环境 |
| ix | 继承执行 |
| m | 允许PROT_EXEC与mmap(2)调用 |
| l | 链接 |

## 相关链接

* [Apparmor的绕过](https://zhuanlan.zhihu.com/p/457269937)
* [什么是AppArmor，以及如何保持Ubuntu安全？](https://mos86.com/82456.html)
* [在 Linux 上用 SELinux 或 AppArmor 实现强制访问控制（MAC）](https://mp.weixin.qq.com/s/yAKylMQjswe47g9p9Ey3KQ)
* [Linux 下selinux和AppArmor安全策略初探](https://mp.weixin.qq.com/s/19u1FdcxbUxKN-4n-EH_wQ)
* [Linux安全模块(LSM)之AppArmor](https://mp.weixin.qq.com/s/mStg8OMl3qC_l8itTlhhpw)
* []()
* []()
* []()
* []()

* https://zhuanlan.zhihu.com/p/457269937
* https://mos86.com/82456.html
* https://ubuntuqa.com/article/719.html